<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--titulo-->
    <title>ColorsNetwork</title>
    <!--libreria-css-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
    <!--estilos-->
    <link rel="stylesheet" href="estilos.css">
    <!--sweet alert-->
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!--libreria-neurona-->
    <script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>
    <!--vue-->
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <!--firebase-->
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.6.2/firebase-app.js"></script>
    <!-- TODO: Add SDKs for Firebase products that you want to use
        https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="https://www.gstatic.com/firebasejs/8.6.2/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.2/firebase-firestore.js"></script>
    <script>
        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        var firebaseConfig = {
            apiKey: "AIzaSyCstrc84On7JudW6eIUYXR6VhBty2FZehk",
            authDomain: "ml5neuralnetwork.firebaseapp.com",
            projectId: "ml5neuralnetwork",
            storageBucket: "ml5neuralnetwork.appspot.com",
            messagingSenderId: "727824220935",
            appId: "1:727824220935:web:a40f1dc2388ecd9863fba2",
            measurementId: "G-464PFPQGQQ"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        firebase.analytics();
        var db = firebase.firestore();
    </script>
  </head>
  <body>
    <!--APP-->
    <main id="app">
    <div class="container-fluid p-4">
        <div class="row align-items-center g-5">
            <div class="col-md-4"></div>
            <div class="col-md-4">
                <div class="card p-4">
                    <center>
                        <img class="card-img-top" style="width: 250px;" src="https://learn.ml5js.org/_media/reference__header-neural-network.png" alt="">
                    </center>
                    <div class="card-body text-center">
                        <h4 class="card-title">¿Qué color es éste?</h4>
                        <p class="card-text" style="color: #6f42c1;">(<b>Neurona</b>)</p>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label>R</label>
                            <input type="number" v-model.number="input.r" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label>G</label>
                            <input type="number" v-model.number="input.g" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label>B</label>
                            <input type="number" v-model.number="input.b" class="form-control">
                        </div>
                        <div class="col-md-12">
                            <button @click="iniciar()" style="width: 100%; background-color: #6f42c1;" type="button" class="btn btn-md btn-dark">Iniciar</button>
                        </div>
                    </div>
                    <div v-if="resultados" class="card-body text-center">
                        <div class="card-body text-center border border-success rounded shadow" style="border-color: #6f42c1 !important;">
                            <p><b style="color: #6f42c1;">Neurona: </b>Creo que es:</p>
                        </div>
                        <div class="p-4 mt-2 border shadow rounded" style="overflow: auto; height: 120px;">
                            <div v-for="(resultado, index) in resultados">
                                <div v-if="index == 0" class="border border-success rounded shadow p-2" style="border-color: #6f42c1 !important;">
                                    <p style="margin: 0px;">
                                        {{index + 1}} - Color: <b>{{resultado.label}}</b>
                                        <br>
                                        Seguro un: {{(resultado.confidence * 100).toFixed(2)}} %
                                    </p>
                                </div>
                                <div v-else class="p-2 mt-3">
                                    <p style="margin: 0px;">
                                        {{index + 1}} - Color: <b>{{resultado.label}}</b>
                                        <br>
                                        Seguro un: {{(resultado.confidence * 100).toFixed(2)}} %
                                    </p>
                                </div>
                            </div>
                        </div>
                        <br>
                        <div class="row">
                            <div class="col-md-6">
                                <button @click="mal = true" type="button" style="width: 100%; background-color: #6f42c1;" class="btn btn-md btn-dark">Mal</button>
                            </div>
                            <div class="col-md-6">
                                <button @click="bien()" type="button" style="width: 100%; background-color: #6f42c1;" class="btn btn-md btn-dark">Bien</button> 
                            </div>
                            <div v-if="mal" class="col-md-12 mt-4">
                                <input  v-model="color" class="form-control mb-2 mt-2" type="text" placeholder="¿Qué color es?">
                                <button @click="guardar()" type="button" style="width: 100%; background-color: #6f42c1;" class="btn btn-md btn-dark">Enseñar</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4"></div>
        </div>
        </div>
    </main>
    <!--CONFIGURACION-->
    <script>
        var app = new Vue({
            el: '#app',
            data: {
                // Step 1: load data or create some data
                db: [],
                // Step 2: set your neural network options
                options:{
                    task: "classification",
                    debug: true,
                },
                // Step 3: initialize your neural network
                nn: null,
                // Step 4: add data to the neural network
                inputs: null,
                output: null,
                // Step 6: train your neural network
                trainingOptions: {
                    epochs: 90,
                    batchSize: 90,
                },
                // Step 8: make a classification
                input: {
                    r: 0,
                    g: 0,
                    b: 0,
                },
                // Step 9: show results
                resultados: null,

                mal: false,
                color: null,
            },
            created() {
                // se obtiene la base de datos
                db.collection("colores").onSnapshot((querySnapshot) => {
                    let colores = []
                    querySnapshot.forEach((doc) => {
                        colores.push(doc.data())
                    })
                    this.db = colores
                })
            },
            methods: {
                iniciar(){
                    // Step 3: initialize your neural network
                    this.nn = ml5.neuralNetwork(this.options)
                    // Step 4: add data to the neural network
                    this.db.forEach((item) => {
                        this.inputs = {
                            r: item.r,
                            g: item.g,
                            b: item.b,
                        };
                        this.output = {
                            color: item.color,
                        };
                        this.nn.addData(this.inputs, this.output)
                    });
                    // Step 5: normalize your data;
                    this.nn.normalizeData()
                    this.nn.train(this.trainingOptions, this.finishedTraining)
                },
                // Step 7: use the trained model
                finishedTraining(){
                    this.classify()
                },
                // Step 8: make a classification
                classify() {
                    
                    this.nn.classify(this.input, this.handleResults)
                },
                // Step 9: define a function to handle the results of your classification
                handleResults(error, result) {
                    if (error) {
                        console.error(error)
                        return
                    }
                    // {label: 'red', confidence: 0.8};
                    this.resultados = result
                },
                // si esta bien
                bien(){
                    let porcentajes = []
                    for (const resultado of this.resultados) {
                        porcentajes.push(resultado.confidence)
                    }
                    max = Math.max(...porcentajes)
                    for (const resultado of this.resultados) {
                        if(resultado.confidence == max){
                            alert('Color:' + resultado.label + '; ' + '%:' + resultado.confidence)
                        }
                    }
                    this.limpiar()
                },
                // aprender
                guardar(){
                    // ventana cargando
                    Swal.fire({
                        icon: 'success',
                        title: 'Aprendiendo...',
                        html: `
                        <center>
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </center>
                        `,
                        showConfirmButton: false,
                    })
                    // crea item de aprendizaje
                    let item = { r: this.input.r, g: this.input.g, b: this.input.b, color: this.color }
                    // se guarda en la base de datos
                    db.collection("colores").add(item)
                    .then((docRef) => {
                        // finalizar ventana de carga
                        Swal.close()
                        // mensaje de consola
                        console.log("Guardado correctamente con el ID: ", docRef.id)
                        // volver a intentar
                        this.iniciar()
                        // limpiar
                        this.mal = false
                    })
                    .catch((error) => {
                        // finalizar ventana de carga
                        Swal.close()
                        // ventana de error
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Ha ocurrido un error inesperado, revisa la consola del navegador para más detalles.',
                            showConfirmButton: true,
                            confirmButtonText: 'Entendido',
                        })
                        // mensaje de consola
                        console.error("Error: ", error);
                    })
                },
                // limpiamos campos
                limpiar(){
                    this.input.r = 0
                    this.input.g = 0
                    this.input.b = 0
                    this.color = 0
                    this.resultados = null
                    this.color = null
                    this.mal = false
                }
            },
        })
    </script>
  </body>
</html>